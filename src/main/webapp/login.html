<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Login - Encurtador</title>

    <!-- Bootstrap 5 (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!--
  Tela de login (mock):
  - Faz POST em /rest/api/auth/login
  - Se OK: mostra popup com JWT e redireciona para /bemvindo.html
-->
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 100vh;">
        <div class="col-12 col-sm-10 col-md-7 col-lg-5">

            <div class="card shadow-sm">
                <div class="card-body p-4">

                    <h1 class="h4 mb-1">Acesso ao Sistema</h1>
                    <p class="text-muted mb-4">Mock: <b>user</b> / <b>123456</b></p>

                    <form id="formLogin">

                        <div class="mb-3">
                            <label for="user" class="form-label">Usuário</label>
                            <input id="user" name="user" type="text" class="form-control" value="user" autocomplete="username" required>
                        </div>

                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha</label>
                            <input id="senha" name="senha" type="password" class="form-control" value="123456" autocomplete="current-password" required>
                        </div>

                        <button id="btnLogin" type="submit" class="btn btn-primary w-100">
                            Entrar
                        </button>

                        <div id="msgOk" class="alert alert-success mt-3 d-none" role="alert"></div>
                        <div id="msgErr" class="alert alert-danger mt-3 d-none" role="alert"></div>

                    </form>

                </div>
            </div>

            <p class="text-center text-muted mt-3 small mb-0">
                Encurtador URL - Demo
            </p>
        </div>
    </div>
</div>

<script>
    (function () {

        // Context-root da aplicação no WildFly
        var BASE_APP = "/encurtador-url";

        // Endpoint de login (JAX-RS)
        var LOGIN_URL = BASE_APP + "/rest/api/auth/login";

        var form = document.getElementById("formLogin");
        var btnLogin = document.getElementById("btnLogin");

        var msgOk = document.getElementById("msgOk");
        var msgErr = document.getElementById("msgErr");

        function hideAlerts() {
            msgOk.classList.add("d-none");
            msgErr.classList.add("d-none");
            msgOk.textContent = "";
            msgErr.textContent = "";
        }

        function showOk(texto) {
            msgOk.textContent = texto;
            msgOk.classList.remove("d-none");
        }

        function showErr(texto) {
            msgErr.textContent = texto;
            msgErr.classList.remove("d-none");
        }

        form.addEventListener("submit", function (event) {
            event.preventDefault();

            hideAlerts();
            btnLogin.disabled = true;

            var user = document.getElementById("user").value;
            var senha = document.getElementById("senha").value;

            var payload = { user: user, senha: senha };

            fetch(LOGIN_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },

                // mantém cookie JSESSIONID (sessão)
                credentials: "same-origin",

                body: JSON.stringify(payload)
            })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        var texto = (data && data.mensagem) ? data.mensagem : "Falha no login.";
                        throw new Error(texto);
                    });
                }
                return response.json();
            })
            .then(function (data) {

                // guardamos o usuário só para mostrar na tela de boas-vindas
                localStorage.setItem("usuarioLogado", user);

                // pega o token retornado pelo backend
                var token = data && data.token ? data.token : "";

                // feedback na tela
                showOk("Login realizado com sucesso. Exibindo token...");

                // POPUP COM O HASH (JWT) - apenas demonstração
                if (token) {
                    alert(
                        "Login realizado com sucesso!\n\n" +
                        "JWT gerado:\n\n" +
                        token
                    );
                } else {
                    alert("Login realizado com sucesso! (Token não retornou no response)");
                }

                // após fechar o popup, redireciona
                window.location.href = BASE_APP + "/bemvindo.html";
            })
            .catch(function (err) {
                showErr(err.message || "Erro inesperado.");
            })
            .finally(function () {
                btnLogin.disabled = false;
            });
        });

    })();
</script>
</body>
</html>
